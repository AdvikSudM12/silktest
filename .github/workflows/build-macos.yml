name: ðŸŽ Build macOS App

on:
  push:
    branches: [ main, macos-build-test ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ” System Info
      run: |
        echo "ðŸ–¥ï¸ macOS Version: $(sw_vers -productVersion)"
        echo "ðŸ—ï¸ Architecture: $(uname -m)"
        echo "ðŸ Python: $(python3 --version)"
        echo "ðŸ“¦ Node.js: $(node --version)"
        echo "ðŸ“‹ NPM: $(npm --version)"
        
    - name: ðŸ Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        if [ -f "pyqt_app/requirements.txt" ]; then
          pip install -r pyqt_app/requirements.txt
        fi
        if [ -f "scripts/requirements.txt" ]; then
          pip install -r scripts/requirements.txt
        fi
        
    - name: ðŸ“¦ Install Node.js dependencies
      run: npm ci
      
    - name: ðŸ”¨ Compile TypeScript
      run: |
        if [ -f "tsconfig.json" ]; then
          npx tsc
          echo "âœ… TypeScript compiled successfully"
        else
          echo "âš ï¸ No tsconfig.json found, skipping TypeScript compilation"
        fi
        
    - name: â¬‡ï¸ Download Node.js runtime
      run: |
        if [ ! -d "embedded_node" ]; then
          echo "ðŸ“¥ Downloading Node.js runtime for macOS..."
          
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñƒ
          if [[ $(uname -m) == "arm64" ]]; then
            NODE_ARCH="arm64"
            NODE_URL="https://nodejs.org/dist/v18.18.0/node-v18.18.0-darwin-arm64.tar.gz"
            NODE_FOLDER="node-v18.18.0-darwin-arm64"
          else
            NODE_ARCH="x64"
            NODE_URL="https://nodejs.org/dist/v18.18.0/node-v18.18.0-darwin-x64.tar.gz"
            NODE_FOLDER="node-v18.18.0-darwin-x64"
          fi
          
          echo "ðŸ—ï¸ Architecture: $NODE_ARCH"
          curl -o node-runtime.tar.gz "$NODE_URL"
          tar -xzf node-runtime.tar.gz
          mv "$NODE_FOLDER" embedded_node
          rm node-runtime.tar.gz
          echo "âœ… Node.js runtime downloaded"
        else
          echo "âœ… embedded_node already exists"
        fi
        
    - name: ðŸ”§ Update PyInstaller spec
      run: |
        echo "ðŸ”§ Updating PyInstaller configuration..."
        sed -i '' 's|macos_build/.env.template|macos_build/env_template.txt|g' macos_build/gosilk_staff.spec
        
    - name: ðŸ”¨ Build with PyInstaller
      run: |
        echo "ðŸ”¨ Building application with PyInstaller..."
        pyinstaller macos_build/gosilk_staff.spec --clean
        
    - name: ðŸ“‹ Copy Node.js runtime to app bundle
      run: |
        echo "ðŸ“‹ Copying Node.js runtime to app bundle..."
        cp -r embedded_node "dist/GoSilk Staff.app/Contents/Resources/"
        chmod +x "dist/GoSilk Staff.app/Contents/Resources/embedded_node/bin/node"
        
    - name: âš™ï¸ Copy configuration template
      run: |
        echo "âš™ï¸ Copying configuration template..."
        cp macos_build/env_template.txt "dist/GoSilk Staff.app/Contents/Resources/.env.template"
        
    - name: ðŸ” Verify app bundle
      run: |
        echo "ðŸ” Verifying app bundle..."
        if [ -d "dist/GoSilk Staff.app" ]; then
          APP_SIZE=$(du -sh "dist/GoSilk Staff.app" | cut -f1)
          echo "âœ… App bundle created successfully!"
          echo "ðŸ“¦ Size: $APP_SIZE"
          echo "ðŸ“ Path: dist/GoSilk Staff.app"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
          echo "ðŸ“‹ App bundle structure:"
          ls -la "dist/GoSilk Staff.app/Contents/"
          ls -la "dist/GoSilk Staff.app/Contents/MacOS/"
          ls -la "dist/GoSilk Staff.app/Contents/Resources/" | head -10
        else
          echo "âŒ App bundle not found!"
          exit 1
        fi
        
    - name: ðŸ“¦ Create DMG
      run: |
        echo "ðŸ“¦ Creating DMG installer..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· git Ñ‚ÐµÐ³Ð° Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð´Ð°Ñ‚Ñƒ
        if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="$(date +%Y%m%d)-$(echo ${GITHUB_SHA} | cut -c1-7)"
        fi
        
        DMG_NAME="GoSilk-Staff-${VERSION}-macOS.dmg"
        
        hdiutil create \
          -volname "GoSilk Staff" \
          -srcfolder "dist/GoSilk Staff.app" \
          -ov \
          -format UDZO \
          "$DMG_NAME"
          
        echo "âœ… DMG created: $DMG_NAME"
        echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV
        
    - name: ðŸ“Š App Info
      run: |
        echo "ðŸ“Š Final build information:"
        echo "ðŸŽ macOS App: dist/GoSilk Staff.app"
        echo "ðŸ“¦ DMG Installer: $DMG_NAME"
        echo "ðŸ“ App Size: $(du -sh "dist/GoSilk Staff.app" | cut -f1)"
        echo "ðŸ“ DMG Size: $(du -sh "$DMG_NAME" | cut -f1)"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ»Ð¸Ð· Ð½Ð¾Ñ‚Ñ‹
        cat > release-notes.md << EOF
        # ðŸŽµ GoSilk Staff Ð´Ð»Ñ macOS
        
        ## ðŸ“¦ Ð§Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾:
        - âœ… ÐÐ²Ñ‚Ð¾Ð½Ð¾Ð¼Ð½Ð¾Ðµ macOS Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ (.app bundle)
        - âœ… Ð’ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ Python runtime
        - âœ… Ð’ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ Node.js runtime  
        - âœ… Ð’ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹
        - âœ… Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸ÑŽ
        
        ## ðŸ’» Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ:
        - macOS 10.14+ (Mojave Ð¸Ð»Ð¸ Ð½Ð¾Ð²ÐµÐµ)
        - ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°: $(uname -m)
        - RAM: 4GB+ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ
        
        ## ðŸš€ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:
        1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ DMG Ñ„Ð°Ð¹Ð»
        2. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ DMG 
        3. ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ "GoSilk Staff.app" Ð² Ð¿Ð°Ð¿ÐºÑƒ Applications
        4. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
        
        ## âš™ï¸ ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº:
        1. ÐŸÑ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°ÑÑ‚ Ð¿Ð°Ð¿ÐºÑƒ ~/.gosilk_staff/
        2. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ð°Ñˆ .env Ñ„Ð°Ð¹Ð» Ð² ~/.gosilk_staff/.env
        3. Ð˜Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸" Ð´Ð»Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²
        
        ---
        
        ðŸ“… Ð¡Ð±Ð¾Ñ€ÐºÐ°: $(date)  
        ðŸ”— ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${GITHUB_SHA}  
        ðŸ—ï¸ ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°: $(uname -m)
        EOF
        
    - name: ðŸ”º Upload App Bundle
      uses: actions/upload-artifact@v4
      with:
        name: GoSilk-Staff-macOS-App
        path: dist/GoSilk Staff.app
        retention-days: 30
        
    - name: ðŸ”º Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: GoSilk-Staff-macOS-DMG
        path: ${{ env.DMG_NAME }}
        retention-days: 90
        
    - name: ðŸ”º Upload Release Notes
      uses: actions/upload-artifact@v4
      with:
        name: Release-Notes
        path: release-notes.md
        retention-days: 30
        
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ GitHub Release Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‚ÐµÐ³Ð¾Ð²
    - name: ðŸš€ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.DMG_NAME }}
        body_path: release-notes.md
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 