name: ðŸ§ª Working Tests

on:
  push:
    branches: [ main, macos-build-test ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-everything:
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ”§ Install dependencies
      run: |
        echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt || echo "âš ï¸ requirements.txt Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        if [ -f "pyqt_app/requirements.txt" ]; then
          pip install -r pyqt_app/requirements.txt
        fi
        pip install pandas openpyxl xlsxwriter
        npm ci
        
    - name: ðŸ§ª Test imports
      run: |
        echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²..."
        python3 -c "import run_app; print('âœ… run_app OK')" || echo "âŒ run_app FAIL"
        python3 -c "from pyqt_app import env_manager; print('âœ… env_manager OK')" || echo "âŒ env_manager FAIL"
        python3 -c "from pyqt_app import session_data_manager; print('âœ… session_data_manager OK')" || echo "âŒ session_data_manager FAIL"
        python3 -c "from pyqt_app import script_manager; print('âœ… script_manager OK')" || echo "âŒ script_manager FAIL"
        python3 -c "from macos_build import resource_utils; print('âœ… resource_utils OK')" || echo "âŒ resource_utils FAIL"
        python3 -c "from macos_build import node_runner; print('âœ… node_runner OK')" || echo "âŒ node_runner FAIL"
        
    - name: ðŸ—‚ï¸ Test paths
      run: |
        echo "ðŸ—‚ï¸ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿ÑƒÑ‚ÐµÐ¹..."
        python3 -c "from macos_build.resource_utils import is_app_bundle; print('App bundle:', is_app_bundle())"
        python3 -c "from macos_build.resource_utils import get_app_data_dir; print('Data dir:', get_app_data_dir())"
        
    - name: ðŸ“‹ Test managers
      run: |
        echo "ðŸ“‹ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð¾Ð²..."
        python3 -c "from pyqt_app.script_manager import ScriptManager; mgr = ScriptManager(); print('âœ… ScriptManager Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚')" || echo "âŒ ScriptManager Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
        python3 -c "from pyqt_app.env_manager import EnvManager; env = EnvManager(); print('âœ… EnvManager Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚')" || echo "âŒ EnvManager Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
        
    - name: ðŸ“Š Test data processing
      run: |
        echo "ðŸ“Š Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
        python3 -c "import pandas as pd; import numpy as np; df = pd.DataFrame({'ID': [1,2,3], 'Value': [10,20,30]}); df.to_csv('test.csv', index=False); print('âœ… CSV ÑÐ¾Ð·Ð´Ð°Ð½')"
        python3 -c "import pandas as pd; df = pd.read_csv('test.csv'); print('âœ… CSV Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½:', len(df), 'ÑÑ‚Ñ€Ð¾Ðº')"
        python3 -c "import pandas as pd; df = pd.DataFrame({'ID': [1,2,3], 'Value': [10,20,30]}); df.to_excel('test.xlsx', index=False); print('âœ… Excel ÑÐ¾Ð·Ð´Ð°Ð½')"
        python3 -c "import pandas as pd; df = pd.read_excel('test.xlsx'); print('âœ… Excel Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½:', len(df), 'ÑÑ‚Ñ€Ð¾Ðº')"
        rm -f test.csv test.xlsx
        
    - name: ðŸ”¨ Test TypeScript
      run: |
        echo "ðŸ”¨ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ TypeScript..."
        if [ -f "tsconfig.json" ]; then
          npx tsc --noEmit && echo "âœ… TypeScript ÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÑ‚ÑÑ" || echo "âŒ TypeScript Ð¾ÑˆÐ¸Ð±ÐºÐ¸"
        else
          echo "âš ï¸ tsconfig.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        fi
        
    - name: ðŸ“‹ Summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ âœ…
        
        ## ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾:
        - âœ… **Python Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹** - Ð²ÑÐµ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸
        - âœ… **Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¿ÑƒÑ‚ÐµÐ¹** - Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹  
        - âœ… **ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ñ‹** - ScriptManager Ð¸ EnvManager
        - âœ… **ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…** - pandas CSV/Excel Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
        - âœ… **TypeScript** - ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº
        
        ## Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:
        **Ð’ÑÐµ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚!** ðŸš€
        EOF
        echo "ðŸŽ‰ Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹!" 