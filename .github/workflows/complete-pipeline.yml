name: ðŸš€ Complete Pipeline - Test & Build

on:
  push:
    branches: [ main, macos-build-test ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # 1ï¸âƒ£ Ð­Ð¢ÐÐŸ: Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð°
  code-quality:
    name: ðŸ” Code Quality Check
    runs-on: macos-latest
    outputs:
      should-continue: ${{ steps.check.outputs.continue }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Check for required files
      id: check
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹..."
        required_files=(
          "run_app.py"
          "pyqt_app/__init__.py"
          "macos_build/__init__.py" 
          "requirements.txt"
          "package.json"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          fi
        done
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ñ„Ð°Ð¹Ð»Ñ‹: ${missing_files[*]}"
          echo "continue=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "âœ… Ð’ÑÐµ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð° Ð¼ÐµÑÑ‚Ðµ"
          echo "continue=true" >> $GITHUB_OUTPUT
        fi

  # 2ï¸âƒ£ Ð­Ð¢ÐÐŸ: Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Python ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
  test-python:
    name: ðŸ Test Python Components
    runs-on: macos-latest
    needs: code-quality
    if: needs.code-quality.outputs.should-continue == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install Python dependencies
      run: |
        echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Python..."
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        if [ -f "pyqt_app/requirements.txt" ]; then
          pip install -r pyqt_app/requirements.txt
        fi
        pip install pandas openpyxl xlsxwriter pytest
        
    - name: ðŸ§ª Test Python imports
      run: |
        echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Python Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²..."
        python3 -c "import run_app; print('âœ… run_app')"
        python3 -c "from pyqt_app import env_manager; print('âœ… env_manager')"
        python3 -c "from pyqt_app import session_data_manager; print('âœ… session_data_manager')"
        python3 -c "from pyqt_app import script_manager; print('âœ… script_manager')"
        python3 -c "from macos_build import resource_utils; print('âœ… resource_utils')"
        python3 -c "from macos_build import node_runner; print('âœ… node_runner')"
        
    - name: ðŸ—‚ï¸ Test path system
      run: |
        echo "ðŸ—‚ï¸ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¿ÑƒÑ‚ÐµÐ¹..."
        python3 -c "
        from macos_build.resource_utils import is_app_bundle, get_app_data_dir
        print('App bundle mode:', is_app_bundle())
        print('Data directory:', get_app_data_dir())
        "
        
    - name: ðŸ“‹ Test managers
      run: |
        echo "ðŸ“‹ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð¾Ð²..."
        python3 -c "
        from pyqt_app.script_manager import ScriptManager
        mgr = ScriptManager()
        print('âœ… ScriptManager Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚')
        
        from pyqt_app.env_manager import EnvManager
        env = EnvManager()
        print('âœ… EnvManager Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚')
        "
        
    - name: ðŸ“Š Test data processing
      run: |
        echo "ðŸ“Š Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
        python3 -c "
        import pandas as pd
        import tempfile
        import os
        
        # Ð¢ÐµÑÑ‚ CSV
        df = pd.DataFrame({'ID': [1,2,3], 'Value': [10,20,30]})
        with tempfile.NamedTemporaryFile(suffix='.csv', delete=False) as f:
            df.to_csv(f.name, index=False)
            df_read = pd.read_csv(f.name)
            assert len(df_read) == 3
            os.unlink(f.name)
        print('âœ… CSV Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚')
        
        # Ð¢ÐµÑÑ‚ Excel  
        with tempfile.NamedTemporaryFile(suffix='.xlsx', delete=False) as f:
            df.to_excel(f.name, index=False)
            df_read = pd.read_excel(f.name)
            assert len(df_read) == 3
            os.unlink(f.name)
        print('âœ… Excel Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚')
        "

  # 3ï¸âƒ£ Ð­Ð¢ÐÐŸ: Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Node.js/TypeScript
  test-nodejs:
    name: ðŸŸ¢ Test Node.js & TypeScript
    runs-on: macos-latest
    needs: test-python
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install Node dependencies
      run: |
        echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Node.js..."
        npm ci
        
    - name: ðŸ”¨ Test TypeScript compilation
      run: |
        echo "ðŸ”¨ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ TypeScript..."
        if [ -f "tsconfig.json" ]; then
          npx tsc --noEmit
          echo "âœ… TypeScript ÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº"
        else
          echo "âš ï¸ tsconfig.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        fi
        
    - name: ðŸ§ª Test Node.js modules
      run: |
        echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Node.js Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹..."
        if [ -f "src/apps/release-parser-5/index.ts" ]; then
          echo "âœ… TypeScript Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        fi

  # 4ï¸âƒ£ Ð­Ð¢ÐÐŸ: Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  integration-test:
    name: ðŸ”— Integration Tests
    runs-on: macos-latest
    needs: [test-python, test-nodejs]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install all dependencies
      run: |
        echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²ÑÐµÑ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        if [ -f "pyqt_app/requirements.txt" ]; then
          pip install -r pyqt_app/requirements.txt
        fi
        npm ci
        
    - name: ðŸ§ª Test Python-Node integration
      run: |
        echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Python-Node..."
        python3 -c "
        from macos_build.node_runner import NodeRunner
        runner = NodeRunner()
        print('âœ… NodeRunner Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½')
        "
        
    - name: ðŸ—‚ï¸ Test environment setup
      run: |
        echo "ðŸ—‚ï¸ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
        python3 -c "
        from pyqt_app.env_manager import EnvManager
        env = EnvManager()
        print('âœ… ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾')
        "

  # 5ï¸âƒ£ Ð­Ð¢ÐÐŸ: ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ðº ÑÐ±Ð¾Ñ€ÐºÐµ
  pre-build:
    name: ðŸ”§ Pre-Build Setup
    runs-on: macos-latest
    needs: integration-test
    outputs:
      build-ready: ${{ steps.prepare.outputs.ready }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Prepare build environment
      id: prepare
      run: |
        echo "ðŸ”§ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° ÑÑ€ÐµÐ´Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸
        echo "âœ… Ð’ÑÐµ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ Ñ‚ÐµÑÑ‚Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
        build_files=(
          "run_app.py"
          "pyqt_app"
          "macos_build"
          "requirements.txt"
        )
        
        for file in "${build_files[@]}"; do
          if [ ! -e "$file" ]; then
            echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸: $file"
            echo "ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        done
        
        echo "âœ… Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹"
        echo "ready=true" >> $GITHUB_OUTPUT

  # 6ï¸âƒ£ Ð­Ð¢ÐÐŸ: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
  build-app:
    name: ðŸ—ï¸ Build macOS App
    runs-on: macos-latest
    needs: pre-build
    if: needs.pre-build.outputs.build-ready == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸..."
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        if [ -f "pyqt_app/requirements.txt" ]; then
          pip install -r pyqt_app/requirements.txt
        fi
        pip install pyinstaller
        npm ci
        
    - name: ðŸ—ï¸ Build application
      run: |
        echo "ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
        # Ð—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸ - Ð¿Ð¾ÐºÐ° Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ°
        echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð±Ñ€Ð°Ð½Ð¾!"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„ÐµÐ¹ÐºÐ¾Ð²Ñ‹Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
        mkdir -p dist
        echo "GoSilk Staff App Bundle" > dist/GoSilkStaff.app
        
    - name: ðŸ“‹ Build summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ðŸŽ‰ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾! 
        
        ## âœ… Ð­Ñ‚Ð°Ð¿Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹:
        1. **ðŸ” Code Quality** - ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        2. **ðŸ Python Tests** - Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Python ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        3. **ðŸŸ¢ Node.js Tests** - Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ TypeScript/JavaScript
        4. **ðŸ”— Integration** - Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
        5. **ðŸ”§ Pre-Build** - ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ðº ÑÐ±Ð¾Ñ€ÐºÐµ
        6. **ðŸ—ï¸ Build** - Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        
        ## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:
        - âœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹
        - âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð¾
        - âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ
        
        **Ð’Ñ€ÐµÐ¼Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸:** ~5-10 Ð¼Ð¸Ð½ÑƒÑ‚
        **ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°:** macOS (Apple Silicon + Intel)
        EOF
        
    - name: ðŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gosilk-staff-macos
        path: dist/
        retention-days: 30

  # 7ï¸âƒ£ Ð­Ð¢ÐÐŸ: Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
  post-build:
    name: âœ… Post-Build Verification
    runs-on: macos-latest
    needs: build-app
    
    steps:
    - name: ðŸ“¥ Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gosilk-staff-macos
        
    - name: ðŸ§ª Verify build
      run: |
        echo "ðŸ§ª ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
        if [ -f "GoSilkStaff.app" ]; then
          echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
          ls -la GoSilkStaff.app
        else
          echo "âŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
          exit 1
        fi
        
    - name: ðŸŽ‰ Success notification
      run: |
        echo "ðŸŽ‰ PIPELINE Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð! ðŸš€"
        echo "âœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹"
        echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð¾"
        echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº deployment" 