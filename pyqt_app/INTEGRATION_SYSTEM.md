# Система интеграции скриптов

## Обзор

Система интеграции объединяет PyQt интерфейс с бэкенд-скриптами для автоматического сравнения файлов и обработки ошибок при нажатии кнопки "ПРОВЕРИТЬ ФАЙЛЫ".

## Архитектура интеграции

### 1. Компоненты системы

- **upload_page.py** - PyQt интерфейс со страницей загрузки
- **script_manager.py** - Менеджер для управления скриптами
- **compare_files.py** - Скрипт сравнения файлов (модифицирован)
- **excel_operations.py** - Скрипт обработки Excel (модифицирован)
- **paths.json** - Файл с сохраненными путями

### 2. Workflow интеграции

```
1. Пользователь выбирает Excel файл и директорию
2. Пути автоматически сохраняются в paths.json
3. При нажатии "ПРОВЕРИТЬ ФАЙЛЫ":
   ├── Загружаются пути из paths.json
   ├── Запускается compare_files_with_excel()
   ├── Если найдены ошибки:
   │   ├── Запускается process_excel_errors()
   │   └── Проблемные строки переносятся в отдельный лист
   └── Результаты отображаются в интерфейсе
```

## Модификации скриптов

### compare_files.py

Функция `compare_files_with_excel()` теперь принимает параметры:
- `excel_file_path` - путь к Excel файлу (опционально)
- `directory_path` - путь к директории (опционально)

Если параметры не переданы, они загружаются из `paths.json`.

**Возвращает структуру:**
```python
{
    'success': bool,
    'message': str,
    'results_file': str,
    'error_count': int,
    'results_data': list  # Данные ошибок
}
```

### excel_operations.py

Функция `process_excel_errors()` принимает параметры:
- `excel_file_path` - путь к основному Excel файлу (опционально)
- `error_file_path` - путь к файлу с ошибками (опционально)

Автоматически ищет последний файл результатов если не указан.

**Возвращает структуру:**
```python
{
    'success': bool,
    'message': str,
    'moved_count': int,
    'error_sheet_name': str
}
```

### script_manager.py

Новые методы:
- `load_paths_from_json()` - загрузка путей из JSON
- `run_file_comparison()` - запуск сравнения файлов
- `run_excel_processing()` - обработка Excel файла
- `run_complete_workflow()` - полный workflow

**Метод `run_complete_workflow()` возвращает:**
```python
{
    'success': bool,
    'message': str,
    'stage': str,  # 'comparison', 'excel_processing', 'completed'
    'comparison_result': dict,
    'excel_result': dict
}
```

## Интеграция в upload_page.py

### Обновленный метод check_files()

```python
def check_files(self):
    """Проверка файлов с использованием интегрированных скриптов"""
    # 1. Проверка наличия путей
    # 2. Запуск ScriptManager.run_complete_workflow()
    # 3. Обработка результатов
    # 4. Отображение статуса в интерфейсе
```

### Новый метод update_files_display()

Обновляет отображение файлов после проверки.

## Статусы операций

Система поддерживает следующие статусы:

- **success** - Все файлы найдены, ошибок нет
- **warning** - Найдены ошибки, выполнена обработка
- **error** - Критическая ошибка в выполнении
- **loading** - Процесс выполняется
- **info** - Информационное сообщение

## Файлы результатов

### Файл сравнения
- Путь: `results/file_comparison_results_YYYY-MM-DD_HH-MM-SS.xlsx`
- Содержит: детальная информация об ошибках сравнения

### Лист ошибок в Excel
- Имя: `Ошибки_загрузки_DD.MM.YY`
- Содержит: строки с проблемными файлами из основного файла

## Обработка ошибок

Система обрабатывает следующие типы ошибок:

1. **Отсутствие файлов** - Excel файл или директория не выбраны
2. **Файлы не найдены** - указанные пути не существуют
3. **Ошибки чтения** - проблемы с чтением Excel или директории
4. **Отсутствие столбцов** - необходимые столбцы не найдены в Excel
5. **Ошибки скриптов** - проблемы выполнения backend скриптов

## Пример использования

```python
# В upload_page.py
from pyqt_app.script_manager import ScriptManager

script_manager = ScriptManager()
result = script_manager.run_complete_workflow()

if result['success']:
    if result['error_count'] == 0:
        self.show_status('success', "Все файлы соответствуют!")
    else:
        self.show_status('warning', f"Найдено {result['error_count']} ошибок")
else:
    self.show_status('error', f"Ошибка: {result['message']}")
```

## Тестирование

Для тестирования интеграции:

1. Запустите приложение: `python run_app.py`
2. Выберите Excel файл и директорию
3. Нажмите "ПРОВЕРИТЬ ФАЙЛЫ"
4. Проверьте создание файлов результатов в папке `results/`
5. Проверьте создание листа ошибок в Excel файле (если есть ошибки)

## Troubleshooting

### Проблема: Ошибка "Модуль не найден"
**Решение:** Проверьте, что все пути в sys.path корректны

### Проблема: Файл paths.json не создается
**Решение:** Проверьте права записи в папку `pyqt_app/data/`

### Проблема: Скрипты не выполняются
**Решение:** Проверьте логи в консоли, убедитесь что все зависимости установлены

## Дальнейшее развитие

- Добавление прогресс-бара для длительных операций
- Кэширование результатов сравнения
- Интеграция с системой уведомлений
- Добавление возможности отмены операций
